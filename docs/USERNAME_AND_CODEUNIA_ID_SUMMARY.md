# Username and Codeunia ID Setup Summary

## ğŸ¯ **Objective**
Implement a robust username and Codeunia ID system with proper constraints, validation, and security policies.

## ğŸ“‹ **Database Structure**

### **New Columns Added to `profiles` Table:**
```sql
username VARCHAR(50) UNIQUE          -- User-chosen username
codeunia_id VARCHAR(20) UNIQUE       -- Auto-generated Codeunia ID
username_set BOOLEAN DEFAULT FALSE   -- Whether username has been set
profile_complete BOOLEAN DEFAULT FALSE -- Whether profile is complete
```

### **Indexes Created:**
- `idx_profiles_username` - Fast username lookups
- `idx_profiles_codeunia_id` - Fast Codeunia ID lookups
- `idx_profiles_username_set` - Filter incomplete profiles
- `idx_profiles_profile_complete` - Filter incomplete profiles

## ğŸ”§ **Core Functions Created**

### **1. Codeunia ID Generation**
```sql
generate_codeunia_id() â†’ VARCHAR(20)
-- Format: CD-YYYYMMDD-XXXX
-- Example: CD-20241230-1234
```

### **2. Safe Username Generation**
```sql
generate_safe_username() â†’ VARCHAR(50)
-- Format: userXXXX
-- Example: user1234
```

### **3. Username Validation**
```sql
validate_username(username_param VARCHAR(50)) â†’ BOOLEAN
-- Rules: 3-50 characters, alphanumeric and underscores only
-- Pattern: ^[a-zA-Z0-9_]{3,50}$
```

### **4. Profile Management Functions**
```sql
set_username(user_id UUID, new_username VARCHAR(50)) â†’ BOOLEAN
auto_assign_username(user_id UUID) â†’ BOOLEAN
is_profile_complete(user_id UUID) â†’ BOOLEAN
get_user_profile(user_id UUID) â†’ TABLE
check_username_availability(username_param VARCHAR(50)) â†’ BOOLEAN
```

## ğŸ›¡ï¸ **Security Policies (RLS)**

### **Username Update Constraints:**
- âœ… **Can update username** only if `username_set = FALSE`
- âŒ **Cannot change username** once `username_set = TRUE`
- âœ… **Codeunia ID** is never editable by users
- âœ… **Profile completion** is managed by system

### **Policy Rules:**
```sql
-- Users can view their own profile
auth.uid() = id

-- Users can update their own profile (with username constraints)
auth.uid() = id AND 
(username IS NULL OR 
 (username_set = FALSE) OR 
 (username_set = TRUE AND username unchanged))

-- Public profiles are viewable by all
is_public = true
```

## ğŸ”„ **User Flow Logic**

### **1. On Auth Success:**
```javascript
// Check if profile exists
const { data: profile } = await supabase
  .from('profiles')
  .select('*')
  .eq('id', user.id)
  .single();

if (!profile) {
  // Create new profile with auto-generated Codeunia ID
  await supabase.from('profiles').insert({
    id: user.id,
    email: user.email,
    codeunia_id: null, // Will be auto-generated by trigger
    username_set: false,
    profile_complete: false
  });
  
  // Redirect to setup
  router.push('/setup');
} else if (!profile.profile_complete) {
  // Redirect to complete profile
  router.push('/complete-profile');
}
```

### **2. On Setup Page:**
```javascript
// User enters username
const { data, error } = await supabase.rpc('set_username', {
  user_id: user.id,
  new_username: username
});

if (error) {
  // Handle validation errors
  // - Username already taken
  // - Invalid format
  // - Username already set
}
```

### **3. Auto-Assign Username:**
```javascript
// If user doesn't choose username, auto-assign
const { data, error } = await supabase.rpc('auto_assign_username', {
  user_id: user.id
});
```

## ğŸ“Š **Views Created**

### **1. Incomplete Profiles View**
```sql
incomplete_profiles AS
SELECT id, first_name, last_name, email, username, codeunia_id, 
       username_set, profile_complete, created_at
FROM profiles 
WHERE profile_complete = FALSE OR username_set = FALSE
```

### **2. Profile Statistics View**
```sql
profile_statistics AS
SELECT 
  COUNT(*) as total_profiles,
  COUNT(*) FILTER (WHERE profile_complete = TRUE) as complete_profiles,
  COUNT(*) FILTER (WHERE profile_complete = FALSE) as incomplete_profiles,
  COUNT(*) FILTER (WHERE username_set = TRUE) as usernames_set,
  COUNT(*) FILTER (WHERE username_set = FALSE) as usernames_not_set,
  COUNT(*) FILTER (WHERE codeunia_id IS NOT NULL) as codeunia_ids_generated
FROM profiles
```

## ğŸ¯ **Business Rules**

### **Username Rules:**
- âœ… **Format**: 3-50 characters, alphanumeric and underscores only
- âœ… **Uniqueness**: Must be unique across all users
- âœ… **One-time setting**: Can only be set once per user
- âœ… **Auto-assignment**: System assigns if user doesn't choose

### **Codeunia ID Rules:**
- âœ… **Auto-generation**: Created automatically on profile creation
- âœ… **Format**: `CD-YYYYMMDD-XXXX`
- âœ… **Uniqueness**: Must be unique across all users
- âœ… **Immutable**: Never editable by users

### **Profile Completion Rules:**
- âœ… **Complete**: When username is set (either by user or auto-assigned)
- âœ… **Incomplete**: When username is not set
- âœ… **Redirect**: Incomplete profiles redirect to setup

## ğŸš€ **How to Apply**

### **Option 1: Automated Script**
```bash
node scripts/run-username-setup.js
```

### **Option 2: Manual Execution**
1. Go to your Supabase dashboard
2. Navigate to SQL Editor
3. Copy contents of `USERNAME_AND_CODEUNIA_ID_SETUP.sql`
4. Execute the script

## âœ… **Expected Results**

### **After Setup:**
- âœ… All existing profiles get Codeunia IDs
- âœ… All existing profiles get safe usernames
- âœ… All profiles marked as complete
- âœ… New users will get auto-generated Codeunia IDs
- âœ… Username validation and generation functions ready
- âœ… RLS policies protect username changes
- âœ… Views for incomplete profiles and statistics

### **For New Users:**
- âœ… Auto-generated Codeunia ID on signup
- âœ… Redirected to setup if profile incomplete
- âœ… Can choose username or get auto-assigned
- âœ… Username can only be set once
- âœ… Profile marked complete after username set

## ğŸ” **Testing Functions**

### **Test Codeunia ID Generation:**
```sql
SELECT generate_codeunia_id();
-- Returns: CD-20241230-1234
```

### **Test Safe Username Generation:**
```sql
SELECT generate_safe_username();
-- Returns: user1234
```

### **Test Username Validation:**
```sql
SELECT validate_username('testuser123'); -- Returns: true
SELECT validate_username('test-user');   -- Returns: false
```

### **Test Profile Statistics:**
```sql
SELECT * FROM profile_statistics;
```

## ğŸ¯ **Next Steps**

1. **Run the Database Setup**
   ```bash
   node scripts/run-username-setup.js
   ```

2. **Create Frontend Components**
   - Setup page (`/setup`)
   - Complete profile page (`/complete-profile`)
   - Username validation UI
   - Profile completion checks

3. **Update Auth Flow**
   - Check profile completion on login
   - Redirect to setup if incomplete
   - Handle username validation errors

4. **Test the System**
   - Create new user accounts
   - Test username validation
   - Test auto-assignment
   - Verify Codeunia ID generation

## ğŸ“ **Support**

If you encounter any issues:
1. Check the Supabase dashboard logs
2. Verify the SQL script executed successfully
3. Test the functions manually in SQL Editor
4. Check RLS policies are working correctly

---

**Status**: âœ… Database Setup Complete
**Impact**: ğŸš€ Username and Codeunia ID System Ready
**Security**: ğŸ›¡ï¸ Protected with RLS Policies
**Validation**: âœ… Comprehensive Username Rules 